@*
 * Copyright 2018 Dept. Protein Evolution, Max Planck Institute for Developmental Biology
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@(filepath : String, filename : String, jobID : String, resultname : String)()

<div class="colorOptsAlignment">
    <a type="button" onclick="@{resultname}_download()" id="downloadAlignment"><span>Download PDB file</span></a>
    <a type="button" class="goToParentJob" style="display: none;">Go to Parent Job</a>
</div>
<hr class="horizontal-line"> <br> <br>

<div id="viewport" class="job@jobID"></div><br><br><br>

<script>
        window["@{resultname}_download"] = function(){
            var downloadFilename = "@{resultname}_@{jobID}" + ".pdb";
            var fileURL="/results/files/@{jobID}/@{filename}";
            $.ajax({
                method: "GET",
                url: fileURL
            }).done(function(data){
                DownloadHelper.download(downloadFilename, data);
            })
        };

        $(function () {
            setViewport();

            var parentId = JobModel.getParamValue("parent_id");
            if (parentId) {
                $(".goToParentJob").show().off()
                        .on("click", function () {
                            m.route("/jobs/" + parentId)
                        });
            }
        });

        function setViewport() {
            var $viewport = $("#viewport.job@jobID"); // get specific element for this job (prevent interference with structure modal)

            if($('#tool-tabs').hasClass('fullscreen')) {
                $viewport.width($(window).width() - 100)
                        .height(900)
                        .find('canvas')
                        .first()
                        .remove();
            } else {
                $viewport.width(810)
                        .height(500)
                        .find('canvas')
                        .first()
                        .remove();
            }

            $viewport.ready(function(){
                setTimeout(function() {
                    var stage = new NGL.Stage( $viewport.get(0) );
                    stage.loadFile('@filepath', {defaultRepresentation: true});
                }, 100);
            });

        }

</script>
